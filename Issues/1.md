# Database Migration System Implementation Plan

**Issue #1**: Implement Database Migration System for SQL Server Schema Changes

## Overview

This document outlines the implementation plan for a database migration system that tracks applied changes and generates DDL scripts based on Git diffs. The system integrates with the existing DACPAC serializer to automatically generate migrations as part of the schema extraction process.

## Architecture

### Integration Approach

The migration system is integrated into the existing SqlServer.Schema.FileSystem.Serializer.Dacpac project, extending its functionality to automatically generate migration files after schema extraction. This ensures a seamless workflow where users continue using the same command-line interface.

### Modified Projects

#### 1. SqlServer.Schema.FileSystem.Serializer.Dacpac (Enhanced)
**New Responsibilities**:
- Generate migration files automatically after schema extraction
- Detect changes using Git diff in the output directory
- Create migration scripts in `<outputPath>/migrations/`
- Initialize and maintain Git repository for change tracking

#### 2. SqlServer.Schema.Migration.Runner (New Project)
**Purpose**: Execute migration files against target database

**Responsibilities**:
- Manage migration history in database
- Execute migrations in correct order
- Handle transactions and rollbacks
- Provide detailed execution logging

## Implementation Details

### Migration History Table

The system uses a migration history table as the single source of truth for applied migrations:

```sql
CREATE TABLE [dbo].[DatabaseMigrationHistory] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [MigrationId] NVARCHAR(100) NOT NULL UNIQUE,
    [Filename] NVARCHAR(500) NOT NULL,
    [AppliedDate] DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    [Checksum] NVARCHAR(64) NOT NULL,
    [Status] NVARCHAR(50) NOT NULL,
    [ExecutionTime] INT NULL,
    [ErrorMessage] NVARCHAR(MAX) NULL
);
```

### Bootstrap Migration

The first migration creates the history table itself:

```sql
-- Migration: 00000000_000000_create_migration_history_table.sql
-- MigrationId: 00000000_000000_create_migration_history_table
-- Description: Bootstrap migration - creates the migration tracking table
-- Author: System
-- Date: System Bootstrap

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'DatabaseMigrationHistory' AND schema_id = SCHEMA_ID('dbo'))
BEGIN
    CREATE TABLE [dbo].[DatabaseMigrationHistory] (
        [Id] INT IDENTITY(1,1) PRIMARY KEY,
        [MigrationId] NVARCHAR(100) NOT NULL UNIQUE,
        [Filename] NVARCHAR(500) NOT NULL,
        [AppliedDate] DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        [Checksum] NVARCHAR(64) NOT NULL,
        [Status] NVARCHAR(50) NOT NULL,
        [ExecutionTime] INT NULL,
        [ErrorMessage] NVARCHAR(MAX) NULL
    );
    
    -- Self-register this bootstrap migration
    INSERT INTO [dbo].[DatabaseMigrationHistory] 
        ([MigrationId], [Filename], [Checksum], [Status], [ExecutionTime])
    VALUES 
        ('00000000_000000_create_migration_history_table', 
         '00000000_000000_create_migration_history_table.sql',
         'BOOTSTRAP', 
         'Success', 
         0);
END
GO
```

### Git-Based Change Detection

The system leverages Git to detect schema changes:

1. **File Change Detection**:
   ```bash
   git diff --name-status <from-ref> <to-ref> -- "*.sql"
   ```
   
2. **Change Types**:
   - `A` (Added) → Generate CREATE statements
   - `M` (Modified) → Analyze differences and generate appropriate DDL
   - `D` (Deleted) → Generate DROP statements

3. **Diff Analysis**:
   - Parse unified diff format to understand specific changes
   - Extract old and new versions of SQL objects
   - Determine minimal DDL operations required

### DDL Generation Rules

#### Table Changes
- **New Column**: `ALTER TABLE [schema].[table] ADD [column] <definition>`
- **Dropped Column**: `ALTER TABLE [schema].[table] DROP COLUMN [column]`
- **Modified Column**: `ALTER TABLE [schema].[table] ALTER COLUMN [column] <new_definition>`
- **New Table**: Full `CREATE TABLE` statement from file

#### Index Changes
- **Any Modification**: Always DROP then CREATE
  ```sql
  DROP INDEX IF EXISTS [index_name] ON [schema].[table];
  GO
  CREATE <index_type> INDEX [index_name] ON [schema].[table](<columns>) <options>;
  GO
  ```
- **New Index**: Direct `CREATE INDEX`
- **Deleted Index**: `DROP INDEX IF EXISTS`

#### Constraint Changes
- **Primary Key/Foreign Key**: DROP then CREATE with proper dependency ordering
- **Check/Default Constraints**: Similar drop/create pattern

### Migration File Format

```sql
-- Migration: YYYYMMDD_HHMMSS_descriptive_name.sql
-- MigrationId: YYYYMMDD_HHMMSS_descriptive_name
-- Generated: 2025-01-25 14:30:00 UTC
-- GitFrom: <commit-hash>
-- GitTo: <commit-hash>
-- Author: System
-- Description: <auto-generated description of changes>

BEGIN TRANSACTION;

-- Migration commands here
-- No existence checks - rely on migration history table

COMMIT TRANSACTION;
```

### Dependency Resolution

The system handles object dependencies:

1. **Tables before dependent objects**: Create tables before their indexes/constraints
2. **Drop in reverse order**: Drop constraints/indexes before tables
3. **Foreign keys last**: Handle FK constraints after all tables exist
4. **Cross-schema dependencies**: Analyze and order appropriately

## Integrated Workflow

1. **User runs existing command**: 
   ```bash
   SqlServer.Schema.FileSystem.Serializer.Dacpac.exe <connectionString> <outputPath>
   ```

2. **System performs**:
   - Extracts database to DACPAC (existing)
   - Parses and organizes scripts to `<outputPath>/<databaseName>/` (existing)
   - **NEW**: Automatically generates migrations to `<outputPath>/migrations/`
   - **NEW**: Commits changes to Git repository in output directory

3. **Output structure**:
   ```
   <outputPath>/
   ├── <databaseName>/              # Existing schema files
   │   ├── dbo/
   │   └── ...
   ├── migrations/                  # Auto-created migration files
   │   ├── 00000000_000000_create_migration_history_table.sql
   │   └── YYYYMMDD_HHMMSS_<auto_description>.sql
   └── .git/                        # Auto-initialized for change tracking
   ```

## Project Structure

```
SQL_Server_Compare/
├── SqlServer.Schema.FileSystem.Serializer.Dacpac/ (Enhanced)
│   ├── Program.cs (modified to include migration generation)
│   ├── Migrations/                              # NEW
│   │   ├── MigrationGenerator.cs
│   │   ├── GitIntegration/
│   │   │   ├── GitDiffAnalyzer.cs
│   │   │   ├── GitCommandRunner.cs
│   │   │   └── DiffEntry.cs
│   │   ├── Parsing/
│   │   │   ├── SqlFileChangeDetector.cs
│   │   │   ├── TableChangeParser.cs
│   │   │   ├── IndexChangeParser.cs
│   │   │   └── SchemaChange.cs
│   │   └── Generation/
│   │       ├── MigrationScriptBuilder.cs
│   │       ├── DDLGenerator.cs
│   │       ├── TableDDLGenerator.cs
│   │       ├── IndexDDLGenerator.cs
│   │       └── DependencyResolver.cs
│   └── (existing files)
│
└── SqlServer.Schema.Migration.Runner/           # NEW project
    ├── Program.cs
    ├── Core/
    │   ├── MigrationHistory.cs
    │   ├── MigrationFile.cs
    │   ├── MigrationExecutor.cs
    │   ├── TransactionManager.cs
    │   └── DatabaseConnection.cs
    ├── Scripts/
    │   └── 00000000_000000_create_migration_history.sql
    └── SqlServer.Schema.Migration.Runner.csproj
```

## Command Line Interfaces

### DACPAC Serializer (Enhanced - No Changes to Usage)

```bash
# Existing command - now also generates migrations automatically
SqlServer.Schema.FileSystem.Serializer.Dacpac.exe <connectionString> <outputPath>

# Example:
SqlServer.Schema.FileSystem.Serializer.Dacpac.exe \
  "Server=localhost;Database=MyDB;Trusted_Connection=true;" \
  "C:\Users\petre.chitashvili\repos\gepha\db_comparison"

# This will:
# 1. Extract and serialize the database schema (existing behavior)
# 2. Generate migrations in <outputPath>/migrations/ (new behavior)
# 3. Commit changes to Git repository (new behavior)
```

### Migration Runner (New)

```bash
# Run all pending migrations
SqlServer.Schema.Migration.Runner.exe migrate \
  --connection="Server=localhost;Database=MyDB;..." \
  --migrations="C:\Users\petre.chitashvili\repos\gepha\db_comparison\migrations"

# Check migration status
SqlServer.Schema.Migration.Runner.exe status \
  --connection="..." \
  --migrations="<path-to-migrations>"

# Dry run
SqlServer.Schema.Migration.Runner.exe migrate \
  --connection="..." \
  --migrations="<path-to-migrations>" \
  --dry-run

# Run specific migration
SqlServer.Schema.Migration.Runner.exe migrate \
  --connection="..." \
  --migration="<path-to-specific-migration.sql>"
```

## Implementation Phases

### Phase 1: Core Infrastructure
1. Add MigrationGenerator class to DACPAC project
2. Implement Git integration layer
3. Create basic SQL file change detection
4. Set up migration file format

### Phase 2: Integration with DACPAC Serializer
1. Modify Program.cs to call MigrationGenerator
2. Implement automatic Git repository initialization
3. Add migration folder creation logic
4. Integrate change detection workflow

### Phase 3: DDL Generation
1. Implement table DDL generator
2. Implement index DDL generator
3. Implement constraint DDL generator
4. Add dependency resolution

### Phase 4: Migration Runner Project
1. Create new SqlServer.Schema.Migration.Runner project
2. Implement migration history management
3. Add migration executor with transaction support
4. Implement error handling and logging

### Phase 5: Polish and Testing
1. Add comprehensive CLI options to runner
2. Create integration tests
3. Add validation and safety checks
4. Write documentation

## Key Design Principles

1. **Single Source of Truth**: Migration history table is the only place to check if a migration has been applied
2. **No Existence Checks**: Migrations should fail if they try to create something that already exists
3. **Atomic Operations**: Each migration either fully succeeds or fully fails
4. **Git Integration**: Leverage Git's understanding of file changes
5. **Seamless Integration**: Migration generation happens automatically as part of existing workflow
6. **Backward Compatible**: No changes to existing command-line usage

## Error Handling

1. **Migration Failures**: 
   - Record in history table with error details
   - Continue with remaining migrations (configurable)
   - Provide clear error messages

2. **Rollback Support**:
   - Automatic rollback on failure within transaction
   - Optional down migrations for manual rollback

3. **Validation**:
   - Verify Git references exist
   - Check migration file integrity
   - Validate SQL syntax before execution

## Testing Strategy

1. **Unit Tests**:
   - Git diff parsing
   - SQL file parsing
   - DDL generation logic

2. **Integration Tests**:
   - End-to-end migration generation
   - Migration execution scenarios
   - Error handling cases

3. **Manual Testing**:
   - Real database migrations
   - Complex schema changes
   - Performance with large schemas

## Success Criteria

- [x] GitHub issue created (#1)
- [ ] MigrationGenerator integrated into DACPAC project
- [ ] SqlServer.Schema.Migration.Runner project created
- [ ] Git diff analysis implemented
- [ ] SQL parsing for all object types
- [ ] DDL generation with proper syntax
- [ ] Automatic migration generation working
- [ ] Migration execution with history tracking
- [ ] Comprehensive error handling
- [ ] Documentation and examples
- [ ] Integration tests passing
- [ ] Successfully migrated a real schema

## Notes

- The system focuses on schema changes only, not data migrations
- Large schemas may require performance optimization
- Consider adding support for custom migration scripts
- Future enhancement: Visual diff viewer for migrations

*Collaboration by Claude*